<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Ewoma Classicstore</title>

  <!-- favicon / logo -->
  <link rel="icon" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1763817088/IMG-20250110-WA0108_pgxmqj.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#f7fbff;--card:#fff;--primary:#0b74ff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#071428}
    header{padding:18px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(11,116,255,0.06);background:linear-gradient(180deg, rgba(11,116,255,0.03), transparent)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:56px;height:56px;border-radius:10px;object-fit:cover}
    .brand h1{font-size:18px;margin:0;color:var(--primary)}
    main{padding:20px}
    .welcome{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(11,116,255,0.04);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .welcome h2{margin:0;font-size:20px;color:var(--primary)}
    .controls{display:flex;gap:10px}
    .btn{background:var(--primary);border:0;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff;border:1px solid rgba(11,116,255,0.12);color:var(--primary)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    @media(max-width:920px){.grid{grid-template-columns:1fr;}}
    .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(11,116,255,0.04)}
    .panel h3{margin:0 0 8px}
    .list{display:flex;flex-direction:column;gap:8px}
    .option{padding:10px;border-radius:10px;border:1px solid #eef6ff;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .content{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(11,116,255,0.04);min-height:400px;overflow:auto}
    .hide{display:none}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fff;font-size:14px}
    textarea{min-height:100px}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #f1f5ff;text-align:left;font-size:14px}
    th{background:#fbfdff}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .file-input{display:flex;gap:8px;align-items:center}
    .preview{width:100%;max-height:220px;object-fit:cover;border-radius:8px;margin-top:8px;border:1px solid #eef6ff}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1763817088/IMG-20250110-WA0108_pgxmqj.jpg" alt="logo">
      <div>
        <h1>Welcome To EwomaClassicStore</h1>
        <div class="small">Admin dashboard</div>
      </div>
    </div>
    <div class="controls">
      <button id="refreshBtn" class="btn ghost">Refresh data</button>
      <button id="signOutBtn" class="btn">Sign out</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <aside class="panel">
        <h3>Actions</h3>
        <div class="list">
          <div class="option" data-target="uploadSection">1. Upload a new product <span class="small">(add)</span></div>
          <div class="option" data-target="usersSection">2. View Users <span class="small">(users)</span></div>
          <div class="option" data-target="ordersSection">3. Users Orders <span class="small">(orders)</span></div>
        </div>
      </aside>

      <section class="content">
        <!-- Upload Product -->
        <div id="uploadSection" class="panel-section">
          <h3>Upload a new product</h3>
          <form id="productForm">
            <label for="title">Title</label>
            <input id="title" name="title" required />

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label for="category">Category</label>
                <select id="category" name="category">
                  <option value="human-hair">Human Hair</option>
                  <option value="sdd">SDD / Synthetic</option>
                  <option value="braided">Braided Hair</option>
                  <option value="jewelry">Jewelry</option>
                  <option value="watches">Watches</option>
                </select>
              </div>
              <div class="col">
                <label for="price">Price (₦)</label>
                <input id="price" name="price" type="number" min="0" step="0.01" required />
              </div>
            </div>

            <label for="description" style="margin-top:8px">Description</label>
            <textarea id="description" name="description"></textarea>

            <label style="margin-top:8px">Image (URL or upload)</label>
            <div class="row">
              <input id="imageUrl" placeholder="https://... (optional)" />
              <input id="imageFile" type="file" accept="image/*" />
            </div>
            <img id="preview" class="preview hide" src="" alt="preview" />

            <div style="margin-top:10px;display:flex;gap:8px">
              <button type="submit" class="btn">Upload product</button>
              <button type="button" id="clearForm" class="btn ghost">Clear</button>
            </div>
            <div id="productMsg" class="note"></div>
          </form>
        </div>

        <!-- Users -->
        <div id="usersSection" class="panel-section hide">
          <h3>Registered Users</h3>
          <div id="usersList">Loading users...</div>
        </div>

        <!-- Orders -->
        <div id="ordersSection" class="panel-section hide">
          <h3>User Orders</h3>
          <div id="ordersList">Loading orders...</div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // Firebase (modular) imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';
    // NOTE: storage is NOT used here because we're uploading to Imgur
    // import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from '...';

    // Firebase config (your supplied values)
    const firebaseConfig = {
      apiKey: "AIzaSyAhsWovZGZEwqY1QRJygQ2toECTeQarmsM",
      authDomain: "ewomaclassicstore.firebaseapp.com",
      projectId: "ewomaclassicstore",
      storageBucket: "ewomaclassicstore.firebasestorage.app",
      messagingSenderId: "436665012312",
      appId: "1:436665012312:web:3b6f663ef44217e9c63a2d",
      measurementId: "G-Q090M73LVG"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== Imgur config ==========
    // Client-ID for anonymous uploads (from your screenshot)
    const IMGUR_CLIENT_ID = 'fb533db21a59486'; // <- your Imgur Client ID

    // helper to upload a File to Imgur (returns image link)
    async function uploadToImgur(file, onProgress = null) {
      // Use XMLHttpRequest if you want upload progress; fetch doesn't provide reliable progress for uploads.
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const url = 'https://api.imgur.com/3/image';
        const fd = new FormData();
        fd.append('image', file);

        xhr.open('POST', url);
        xhr.setRequestHeader('Authorization', 'Client-ID ' + IMGUR_CLIENT_ID);

        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable && typeof onProgress === 'function') {
            onProgress(Math.round((e.loaded / e.total) * 100));
          }
        };

        xhr.onload = function() {
          try {
            const res = JSON.parse(xhr.responseText);
            if (res && res.success && res.data && res.data.link) {
              resolve(res.data.link);
            } else {
              reject(res && res.data && res.data.error ? res.data.error : 'Upload failed');
            }
          } catch (err) {
            reject(err.message || err);
          }
        };

        xhr.onerror = function() {
          reject('Network error while uploading to Imgur');
        };

        xhr.send(fd);
      });
    }

    // DOM elements
    const options = document.querySelectorAll('.option');
    const sections = document.querySelectorAll('.panel-section');
    const refreshBtn = document.getElementById('refreshBtn');
    const signOutBtn = document.getElementById('signOutBtn');

    const productForm = document.getElementById('productForm');
    const imageFile = document.getElementById('imageFile');
    const imageUrl = document.getElementById('imageUrl');
    const preview = document.getElementById('preview');
    const productMsg = document.getElementById('productMsg');

    const usersList = document.getElementById('usersList');
    const ordersList = document.getElementById('ordersList');

    // Switch sections
    options.forEach(opt => opt.addEventListener('click', () => {
      const target = opt.dataset.target;
      sections.forEach(s => s.classList.add('hide'));
      document.getElementById(target).classList.remove('hide');

      if (target === 'usersSection') loadUsers();
      if (target === 'ordersSection') loadOrders();
    }));

    // Preview selected image file
    imageFile.addEventListener('change', () => {
      const f = imageFile.files[0];
      if (f) {
        preview.src = URL.createObjectURL(f);
        preview.classList.remove('hide');
      }
    });
    imageUrl.addEventListener('input', () => {
      const v = imageUrl.value.trim();
      if (v) { preview.src = v; preview.classList.remove('hide'); }
      else if (!imageFile.files[0]) { preview.src = ''; preview.classList.add('hide'); }
    });

    // Upload product handler (uploads image to Imgur if a file is selected)
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      productMsg.textContent = '';
      const title = document.getElementById('title').value.trim();
      const category = document.getElementById('category').value;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const description = document.getElementById('description').value.trim();

      if (!title) { productMsg.textContent = 'Title is required'; return; }

      try {
        productMsg.textContent = 'Processing...';

        let imgLink = '';

        // If a file is chosen, upload to Imgur
        if (imageFile.files[0]) {
          productMsg.textContent = 'Uploading image to Imgur...';
          // optional progress callback
          const progressCallback = (pct) => {
            productMsg.textContent = `Uploading image to Imgur... (${pct}%)`;
          };
          try {
            imgLink = await uploadToImgur(imageFile.files[0], progressCallback);
          } catch (err) {
            console.error('Imgur upload error', err);
            productMsg.textContent = 'Imgur upload failed: ' + err;
            return;
          }
        } else if (imageUrl.value.trim()) {
          // Use provided image URL directly
          imgLink = imageUrl.value.trim();
        }

        productMsg.textContent = 'Saving product...';

        // Save product doc in Firestore (createdAt stored as ISO string here;
        // you can use serverTimestamp() if using server-side Cloud Functions)
        await addDoc(collection(db, 'products'), {
          title,
          category,
          price,
          description,
          image: imgLink,
          createdAt: new Date().toISOString()
        });

        productMsg.textContent = 'Product uploaded.';
        productForm.reset();
        preview.src = '';
        preview.classList.add('hide');
      } catch (err) {
        console.error(err);
        productMsg.textContent = 'Upload failed: ' + (err.message || err);
      }
    });

    document.getElementById('clearForm').addEventListener('click', () => {
      productForm.reset();
      preview.src = '';
      preview.classList.add('hide');
      productMsg.textContent = '';
    });

    // Load users from Firestore
    async function loadUsers() {
      usersList.textContent = 'Loading users...';
      try {
        const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if (snap.empty) { usersList.innerHTML = '<div class="small">No users found.</div>'; return; }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Name</th><th>Username</th><th>Email</th><th>Phone</th><th>Created</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');

        snap.forEach(docSnap => {
          const data = docSnap.data();
          const name = (data.displayName || data.name || data.fullName || data.username || '');
          const createdVal = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt || '');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${escapeHtml(data.username||'')}</td><td>${escapeHtml(data.email||'')}</td><td>${escapeHtml(data.phone||'')}</td><td>${escapeHtml(createdVal)}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        usersList.innerHTML = '';
        usersList.appendChild(table);
      } catch (err) {
        console.error(err);
        usersList.textContent = 'Failed to load users';
      }
    }

    // Load orders from Firestore
    async function loadOrders() {
      ordersList.textContent = 'Loading orders...';
      try {
        const q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if (snap.empty) { ordersList.innerHTML = '<div class="small">No orders found.</div>'; return; }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Order ID</th><th>User</th><th>Items</th><th>Total</th><th>Status</th><th>Created</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');

        snap.forEach(d => {
          const data = d.data();
          const id = d.id;
          const items = Array.isArray(data.items) ? data.items.map(i => `${i.name} x${i.qty}`).join(', ') : (data.items || '');
          const createdVal = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt || '');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(id)}</td><td>${escapeHtml(data.userEmail||data.userId||'')}</td><td>${escapeHtml(items)}</td><td>${escapeHtml(data.total||'')}</td><td>${escapeHtml(data.status||'')}</td><td>${escapeHtml(createdVal)}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        ordersList.innerHTML = '';
        ordersList.appendChild(table);
      } catch (err) {
        console.error(err);
        ordersList.textContent = 'Failed to load orders';
      }
    }

    // Refresh button: reload depending on visible section
    refreshBtn.addEventListener('click', () => {
      const active = document.querySelector('.panel-section:not(.hide)');
      if (active) {
        if (active.id === 'usersSection') loadUsers();
        if (active.id === 'ordersSection') loadOrders();
      }
    });

    // Sign out (demo)
    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        alert('Signed out (demo)');
      } catch (e) {
        console.warn(e);
        alert('Sign out failed');
      }
    });

    // Show upload section by default on load
    document.querySelector('[data-target="uploadSection"]').click();

    // small helper to avoid XSS when inserting strings
    function escapeHtml(str){
      if(!str && str !== 0) return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
  </script>
</body>
</html>
