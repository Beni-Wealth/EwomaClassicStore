<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Ewoma Classicstore</title>

  <!-- favicon / logo -->
  <link rel="icon" href="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1763817088/IMG-20250110-WA0108_pgxmqj.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#f7fbff;--card:#fff;--primary:#0b78ff;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#071428}
    header{padding:18px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(11,116,255,0.06);background:linear-gradient(180deg, rgba(11,116,255,0.03), transparent)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:56px;height:56px;border-radius:10px;object-fit:cover}
    .brand h1{font-size:18px;margin:0;color:var(--primary)}
    main{padding:20px}
    .welcome{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(11,116,255,0.04);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .welcome h2{margin:0;font-size:20px;color:var(--primary)}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--primary);border:0;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff;border:1px solid rgba(11,116,255,0.12);color:var(--primary)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    @media(max-width:920px){.grid{grid-template-columns:1fr;}}
    .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(11,116,255,0.04)}
    .panel h3{margin:0 0 8px}
    .list{display:flex;flex-direction:column;gap:8px}
    .option{padding:10px;border-radius:10px;border:1px solid #eef6ff;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .content{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(11,116,255,0.04);min-height:300px;overflow:auto}
    .hide{display:none}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fff;font-size:14px}
    textarea{min-height:100px}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #f1f5ff;text-align:left;font-size:14px}
    th{background:#fbfdff}
    .note{font-size:13px;color:var(--muted);margin-top:10px}
    .small{font-size:13px;color:var(--muted)}
    .file-input{display:flex;gap:8px;align-items:center}
    .preview{width:100%;max-height:220px;object-fit:cover;border-radius:8px;margin-top:8px;border:1px solid #eef6ff}
    /* auth panel */
    .auth-panel{background:linear-gradient(180deg,#fff,#f7fbff);padding:14px;border-radius:10px;border:1px solid rgba(11,116,255,0.04);display:flex;gap:12px;align-items:center}
    .auth-panel .fields{flex:1;display:grid;gap:8px}
    .auth-panel label{margin:0;font-size:13px}
    .auth-panel .msg{font-size:13px;color:#b91c1c}
    .top-row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://res.cloudinary.com/dq7fpxfbc/image/upload/v1763817088/IMG-20250110-WA0108_pgxmqj.jpg" alt="logo">
      <div>
        <h1>Welcome To EwomaClassicStore</h1>
        <div class="small">Admin dashboard</div>
      </div>
    </div>
    <div class="controls">
      <button id="refreshBtn" class="btn ghost">Refresh data</button>
      <button id="signOutBtn" class="btn hide">Sign out</button>
    </div>
  </header>

  <main>
    <!-- AUTH PANEL (on top of admin UI). Visible until signed in. -->
    <div id="authPanel" class="auth-panel" style="margin-bottom:14px">
      <div class="fields">
        <div>
          <label for="adminIdentifier">Username or email</label>
          <input id="adminIdentifier" list="adminUsernames" placeholder="username or email">
          <datalist id="adminUsernames"></datalist>
        </div>
        <div class="top-row">
          <div style="flex:1">
            <label for="adminPassword">Password</label>
            <input id="adminPassword" type="password" placeholder="password">
          </div>
          <div style="min-width:140px">
            <label style="visibility:hidden">.</label>
            <button id="adminSignIn" class="btn" style="width:100%">Sign in</button>
          </div>
        </div>
        <div id="authMsg" class="msg" style="display:none"></div>
      </div>
      <div style="min-width:260px">
        <div style="font-weight:700;color:var(--primary);margin-bottom:8px">Admin access</div>
        <div style="font-size:13px;color:var(--muted)">Sign in with an account created in the users collection. You can type username (autocomplete available) or email.</div>
      </div>
    </div>

    <div class="grid">
      <aside class="panel">
        <h3>Actions</h3>
        <div class="list">
          <div class="option" data-target="uploadSection">1. Upload a new product <span class="small">(add)</span></div>
          <div class="option" data-target="usersSection">2. View Users <span class="small">(users)</span></div>
          <div class="option" data-target="ordersSection">3. Users Orders <span class="small">(orders)</span></div>
        </div>
      </aside>

      <section class="content" id="adminContent" aria-hidden="true" style="display:none">
        <!-- Upload Product -->
        <div id="uploadSection" class="panel-section">
          <h3>Upload a new product</h3>
          <form id="productForm">
            <label for="title">Title</label>
            <input id="title" name="title" required />

            <div class="row" style="margin-top:8px">
              <div class="col">
                <label for="category">Category</label>
                <select id="category" name="category">
                  <option value="human-hair">Human Hair</option>
                  <option value="synthetic">Synthetic</option>
                  <option value="braided">Braided Hair</option>
                  <option value="jewelry">Jewelry</option>
                  <option value="watches">Watches</option>
                </select>
              </div>
              <div class="col">
                <label for="price">Price (₦)</label>
                <input id="price" name="price" type="number" min="0" step="0.01" required />
              </div>
            </div>

            <label for="description" style="margin-top:8px">Description</label>
            <textarea id="description" name="description"></textarea>

            <label style="margin-top:8px">Image (URL or upload)</label>
            <div class="row">
              <input id="imageUrl" placeholder="https://... (optional)" />
              <input id="imageFile" type="file" accept="image/*" />
            </div>
            <img id="preview" class="preview hide" src="" alt="preview" />

            <div style="margin-top:10px;display:flex;gap:8px">
              <button type="submit" class="btn">Upload product</button>
              <button type="button" id="clearForm" class="btn ghost">Clear</button>
            </div>
            <div id="productMsg" class="note"></div>
          </form>
        </div>

        <!-- Users -->
        <div id="usersSection" class="panel-section hide" style="margin-top:12px">
          <h3>Registered Users</h3>
          <div id="usersList">Loading users...</div>
        </div>

        <!-- Orders -->
        <div id="ordersSection" class="panel-section hide" style="margin-top:12px">
          <h3>User Orders</h3>
          <div id="ordersList">Loading orders...</div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    // Firebase (modular) imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, where } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

    // FIREBASE CONFIG: use the project you provided (ewomaclassicstore-43b5e)
    const firebaseConfig = {
      apiKey: "AIzaSyDo8QfyV3FxWtZMgRI-VvxGJWxLErosIZo",
      authDomain: "ewomaclassicstore-43b5e.firebaseapp.com",
      projectId: "ewomaclassicstore-43b5e",
      storageBucket: "ewomaclassicstore-43b5e.firebasestorage.app",
      messagingSenderId: "294976130252",
      appId: "1:294976130252:web:8520570810950d64e14669",
      measurementId: "G-HHG3KC5VZ3"
    };

    // Imgur client ID (used to upload images)
    const IMGUR_CLIENT_ID = 'fb533db21a59486';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const authPanel = document.getElementById('authPanel');
    const adminContent = document.getElementById('adminContent');
    const signOutBtn = document.getElementById('signOutBtn');

    const adminIdentifier = document.getElementById('adminIdentifier');
    const adminPassword = document.getElementById('adminPassword');
    const adminSignIn = document.getElementById('adminSignIn');
    const authMsg = document.getElementById('authMsg');
    const adminUsernames = document.getElementById('adminUsernames');

    const options = document.querySelectorAll('.option');
    const sections = document.querySelectorAll('.panel-section');
    const refreshBtn = document.getElementById('refreshBtn');

    const productForm = document.getElementById('productForm');
    const imageFile = document.getElementById('imageFile');
    const imageUrl = document.getElementById('imageUrl');
    const preview = document.getElementById('preview');
    const productMsg = document.getElementById('productMsg');

    const usersList = document.getElementById('usersList');
    const ordersList = document.getElementById('ordersList');

    // local map username -> email (case-insensitive keys)
    const usernameToEmail = new Map();

    // ---------- load usernames to datalist and map ----------
    async function loadUsernames() {
      adminUsernames.innerHTML = '';
      usernameToEmail.clear();
      try {
        const q = query(collection(db, 'users'), orderBy('username'));
        const snap = await getDocs(q);
        snap.forEach(doc => {
          const d = doc.data();
          const uname = (d.username || '').toString();
          const mail = (d.email || '').toString();
          if (uname) {
            const opt = document.createElement('option');
            opt.value = uname;
            adminUsernames.appendChild(opt);
            usernameToEmail.set(uname.toLowerCase(), mail);
          }
        });
      } catch (e) {
        console.error('loadUsernames failed', e);
      }
    }

    // call on load
    loadUsernames();

    // ---------- helper to resolve identifier -> email ----------
    function resolveToEmail(identifier) {
      if (!identifier) return null;
      identifier = identifier.trim();
      if (identifier.includes('@')) return identifier;
      return usernameToEmail.get(identifier.toLowerCase()) || null;
    }

    // ---------- auth flow ----------
    adminSignIn.addEventListener('click', async () => {
      authMsg.style.display = 'none';
      const idVal = adminIdentifier.value.trim();
      const pw = adminPassword.value;
      if (!idVal || !pw) {
        authMsg.textContent = 'Enter username/email and password.';
        authMsg.style.display = 'block';
        return;
      }
      adminSignIn.disabled = true;
      adminSignIn.textContent = 'Signing in…';

      // try to resolve username
      let email = resolveToEmail(idVal);
      if (!email) {
        // try reload once
        await loadUsernames();
        email = resolveToEmail(idVal);
      }
      if (!email) {
        authMsg.textContent = 'Username not found. Use email or ensure username exists.';
        authMsg.style.display = 'block';
        adminSignIn.disabled = false;
        adminSignIn.textContent = 'Sign in';
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pw);
        // onAuthStateChanged will show admin UI
      } catch (err) {
        console.error('signIn error', err);
        let txt = 'Incorrect username or password.';
        if (err && err.code) {
          if (err.code === 'auth/wrong-password') txt = 'Incorrect password.';
          else if (err.code === 'auth/user-not-found') txt = 'No account found for that email.';
          else if (err.code === 'auth/invalid-email') txt = 'Invalid email address.';
        }
        authMsg.textContent = txt;
        authMsg.style.display = 'block';
        adminSignIn.disabled = false;
        adminSignIn.textContent = 'Sign in';
      }
    });

    // sign out
    signOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error('signOut error', e);
        alert('Sign out failed, check console.');
      }
    });

    // on auth state change - show/hide admin UI
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // not signed in
        authPanel.style.display = 'flex';
        adminContent.style.display = 'none';
        signOutBtn.classList.add('hide');
        // reload usernames for convenience
        loadUsernames();
        return;
      }
      // signed in
      authPanel.style.display = 'none';
      adminContent.style.display = 'block';
      signOutBtn.classList.remove('hide');
      // load default section and content
      document.querySelector('[data-target="uploadSection"]').click();
      await loadUsers(); // pre-load users table
    });

    // ---------- UI: section switching ----------
    options.forEach(opt => opt.addEventListener('click', () => {
      const target = opt.dataset.target;
      sections.forEach(s => s.classList.add('hide'));
      document.getElementById(target).classList.remove('hide');

      if (target === 'usersSection') loadUsers();
      if (target === 'ordersSection') loadOrders();
    }));

    // ---------- preview logic ----------
    imageFile.addEventListener('change', () => {
      const f = imageFile.files[0];
      if (f) {
        preview.src = URL.createObjectURL(f);
        preview.classList.remove('hide');
      }
    });
    imageUrl.addEventListener('input', () => {
      const v = imageUrl.value.trim();
      if (v) { preview.src = v; preview.classList.remove('hide'); }
      else if (!imageFile.files[0]) { preview.src = ''; preview.classList.add('hide'); }
    });

    // ---------- Imgur upload ----------
    async function uploadToImgur(file) {
      const form = new FormData();
      form.append('image', file);
      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: { Authorization: 'Client-ID ' + IMGUR_CLIENT_ID },
        body: form
      });
      const json = await res.json();
      if (!res.ok || !json || !json.data || !json.data.link) {
        throw new Error(json?.data?.error || 'Imgur upload failed');
      }
      return json.data.link;
    }

    // ---------- upload product handler ----------
    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      productMsg.textContent = '';
      const title = document.getElementById('title').value.trim();
      const category = document.getElementById('category').value;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const description = document.getElementById('description').value.trim();

      if (!title) { productMsg.textContent = 'Title is required'; return; }

      try {
        productMsg.textContent = 'Uploading...';
        let imgLink = '';

        if (imageFile.files[0]) {
          try {
            imgLink = await uploadToImgur(imageFile.files[0]);
          } catch (imgErr) {
            console.error('Imgur upload error', imgErr);
            productMsg.textContent = 'Image upload failed: ' + (imgErr.message || imgErr);
            return;
          }
        } else if (imageUrl.value.trim()) {
          imgLink = imageUrl.value.trim();
        }

        // Save product doc to Firestore with server timestamp
        await addDoc(collection(db, 'products'), {
          title,
          category,
          price,
          description,
          image: imgLink || '',
          createdAt: serverTimestamp()
        });

        productMsg.textContent = 'Product uploaded.';
        productForm.reset();
        preview.src = '';
        preview.classList.add('hide');
      } catch (err) {
        console.error(err);
        productMsg.textContent = 'Upload failed: ' + (err.message || err);
      }
    });

    document.getElementById('clearForm').addEventListener('click', () => {
      productForm.reset();
      preview.src = '';
      preview.classList.add('hide');
      productMsg.textContent = '';
    });

    // ---------- Load users ----------
    async function loadUsers() {
      usersList.textContent = 'Loading users...';
      try {
        const q = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if (snap.empty) { usersList.innerHTML = '<div class="small">No users found.</div>'; return; }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Username</th><th>Email</th><th>Phone</th><th>Created</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');

        snap.forEach(d => {
          const data = d.data();
          const tr = document.createElement('tr');
          const createdVal = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt || '');
          tr.innerHTML = `<td>${data.username||''}</td><td>${data.email||''}</td><td>${data.phone||''}</td><td>${createdVal}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        usersList.innerHTML = '';
        usersList.appendChild(table);
      } catch (err) {
        console.error(err);
        usersList.textContent = 'Failed to load users';
      }
    }

    // ---------- Load orders ----------
    async function loadOrders() {
      ordersList.textContent = 'Loading orders...';
      try {
        const q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'));
        const snap = await getDocs(q);
        if (snap.empty) { ordersList.innerHTML = '<div class="small">No orders found.</div>'; return; }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Order ID</th><th>User</th><th>Items</th><th>Total</th><th>Status</th><th>Created</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');

        snap.forEach(d => {
          const data = d.data();
          const id = d.id;
          const items = Array.isArray(data.items) ? data.items.map(i => `${i.name} x${i.qty}`).join(', ') : (data.items || '');
          const createdVal = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toLocaleString() : (data.createdAt || '');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${id}</td><td>${data.userEmail||data.userId||''}</td><td>${items}</td><td>${data.total||''}</td><td>${data.status||''}</td><td>${createdVal}</td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        ordersList.innerHTML = '';
        ordersList.appendChild(table);
      } catch (err) {
        console.error(err);
        ordersList.textContent = 'Failed to load orders';
      }
    }

    // refresh button: reload visible section
    refreshBtn.addEventListener('click', () => {
      const active = document.querySelector('.panel-section:not(.hide)');
      if (active) {
        if (active.id === 'usersSection') loadUsers();
        if (active.id === 'ordersSection') loadOrders();
      }
    });

    // Show upload section by default on load (when admin content visible)
    document.querySelector('[data-target="uploadSection"]').addEventListener('click', () => {
      // nothing else here; onAuthStateChanged will call loadUsers when signed-in
    });

    // expose loadUsernames for manual calls if needed
    window._loadUsernames = loadUsernames;
  </script>
</body>
</html>
