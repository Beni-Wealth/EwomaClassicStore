<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ewomaclassicstore ‚Äî Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg: #f6fbff; /* very light blue */
      --card: #ffffff;
      --accent-blue: #2b9af3; /* primary blue */
      --accent-soft: #e6f4ff; /* soft blue */
      --accent-orange: #ff8a00;
      --muted: #6b7280;
      --glass: rgba(255,255,255,0.6);
      font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#ffffff);color:#0f172a}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}

    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent-blue),#7fd1ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;box-shadow:0 6px 18px rgba(43,154,243,0.15)}
    .brand h1{font-size:18px;margin:0}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    .admin-actions{display:flex;align-items:center;gap:12px}
    .chip{background:var(--card);padding:8px 12px;border-radius:999px;box-shadow:0 4px 18px rgba(15,23,42,0.06);font-weight:600}
    .signout{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:8px 12px;border-radius:10px;cursor:pointer}

    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:18px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 28px rgba(11,52,96,0.05);display:flex;flex-direction:column;gap:12px}
    .card .top{display:flex;justify-content:space-between;align-items:center}
    .metric{font-size:28px;font-weight:700}
    .label{font-size:13px;color:var(--muted)}
    .card-cta{margin-top:auto;display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;gap:10px;align-items:center;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent-blue),#4fb0ff);color:white;box-shadow:0 8px 20px rgba(43,154,243,0.18)}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}

    .emoji{font-size:21px}

    /* header stats bar */
    .hero{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-top:6px}
    .hero p{margin:0;color:var(--muted)}

    /* responsive */
    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:640px){
      .wrap{padding:14px}
      .grid{grid-template-columns:1fr}
      .brand h1{font-size:16px}
      .metric{font-size:24px}
    }

    /* small helpers */
    .loading{opacity:0.6;font-style:italic}
    .error{color:#b91c1c;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">https://res.cloudinary.com/dq7fpxfbc/image/upload/v1763817088/IMG-20250110-WA0108_pgxmqj.jpg</div>
        <div>
          <h1>Admin Dashboard</h1>
          <p>Light blue ¬∑ white ¬∑ touch of orange</p>
        </div>
      </div>
      <div class="admin-actions">
        <div class="chip" id="adminEmail">Not signed in</div>
        <button class="signout" id="signOutBtn" style="display:none">Sign out</button>
      </div>
    </header>

    <div class="hero">
      <div>
        <h2 style="margin:0">Overview</h2>
        <p>Quick access to users, deposits, orders and messages.</p>
      </div>
      <div>
        <button class="btn ghost" id="refreshBtn">Refresh counts üîÑ</button>
      </div>
    </div>

    <main>
      <div class="grid" style="margin-top:16px">

        <div class="card" id="card-users" aria-live="polite">
          <div class="top">
            <div>
              <div class="label">Users</div>
              <div class="metric" id="usersCount">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="emoji">üë•</div>
              <div style="font-size:12px;color:var(--muted);">Total records</div>
            </div>
          </div>
          <div class="card-cta">
            <a class="btn primary" id="goto-users" href="users.html">View users ‚ûú</a>
            <a class="btn ghost" id="users-small" href="users.html">Manage</a>
          </div>
        </div>

        <div class="card" id="card-deposits">
          <div class="top">
            <div>
              <div class="label">Deposits</div>
              <div class="metric" id="depositsCount">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="emoji">üí≥</div>
              <div style="font-size:12px;color:var(--muted);">Incoming funds</div>
            </div>
          </div>
          <div class="card-cta">
            <a class="btn primary" id="goto-deposits" href="admin-deposit.html">View deposits ‚ûú</a>
            <a class="btn ghost" id="deposits-small" href="admin-deposit.html">Manage</a>
          </div>
        </div>

        <div class="card" id="card-orders">
          <div class="top">
            <div>
              <div class="label">Orders</div>
              <div class="metric" id="ordersCount">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="emoji">üì¶</div>
              <div style="font-size:12px;color:var(--muted);">Placed orders</div>
            </div>
          </div>
          <div class="card-cta">
            <a class="btn primary" id="goto-orders" href="admin-orders.html">View orders ‚ûú</a>
            <a class="btn ghost" id="orders-small" href="admin-orders.html">Manage</a>
          </div>
        </div>

        <div class="card" id="card-messages">
          <div class="top">
            <div>
              <div class="label">Messages</div>
              <div class="metric" id="messagesCount">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="emoji">‚úâÔ∏è</div>
              <div style="font-size:12px;color:var(--muted);">Inbox</div>
            </div>
          </div>
          <div class="card-cta">
            <a class="btn primary" id="goto-messages" href="admin-inbox.html">Open inbox ‚ûú</a>
            <a class="btn ghost" id="messages-small" href="admin-inbox.html">Manage</a>
          </div>
        </div>

      </div>

      <div style="margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div id="status" class="loading">Loading counts‚Ä¶</div>
        <div id="errorMsg" class="error" style="display:none"></div>
      </div>

    </main>
  </div>

  <script type="module">
    // --- Firebase SDKs via CDN (modular) ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Paste your firebaseConfig here (you already provided it earlier)
    const firebaseConfig = {
      apiKey: "AIzaSyDo8QfyV3FxWtZMgRI-VvxGJWxLErosIZo",
      authDomain: "ewomaclassicstore-43b5e.firebaseapp.com",
      projectId: "ewomaclassicstore-43b5e",
      storageBucket: "ewomaclassicstore-43b5e.firebasestorage.app",
      messagingSenderId: "294976130252",
      appId: "1:294976130252:web:8520570810950d64e14669",
      measurementId: "G-HHG3KC5VZ3"
    };

    const app = initializeApp(firebaseConfig);
    let analytics;
    try{ analytics = getAnalytics(app); }catch(e){ console.warn('Analytics not initialized', e); }

    const auth = getAuth(app);
    const db = getFirestore(app);

    // allowed admin emails
    const ALLOWED = new Set(["beniwealth70@gmail.com","orivriewoma@gmail.com"]);

    const usersCountEl = document.getElementById('usersCount');
    const depositsCountEl = document.getElementById('depositsCount');
    const ordersCountEl = document.getElementById('ordersCount');
    const messagesCountEl = document.getElementById('messagesCount');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('errorMsg');
    const adminEmailChip = document.getElementById('adminEmail');
    const signOutBtn = document.getElementById('signOutBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    async function fetchCount(collectionName){
      try{
        const colRef = collection(db, collectionName);
        const snap = await getDocs(colRef);
        return snap.size;
      }catch(err){
        throw err;
      }
    }

    async function refreshAll(){
      statusEl.style.display = '';
      statusEl.textContent = 'Refreshing counts‚Ä¶';
      errorEl.style.display = 'none';
      try{
        // run in parallel
        const [users, deposits, orders, messages] = await Promise.all([
          fetchCount('users'),
          fetchCount('deposits'),
          fetchCount('orders'),
          fetchCount('messages')
        ]);

        usersCountEl.textContent = users;
        depositsCountEl.textContent = deposits;
        ordersCountEl.textContent = orders;
        messagesCountEl.textContent = messages;
        statusEl.textContent = 'Counts updated';
      }catch(err){
        console.error(err);
        errorEl.style.display = '';
        errorEl.textContent = 'Error fetching counts ‚Äî check Firestore rules or network. ' + (err.message || '');
        statusEl.style.display = 'none';
      }
    }

    refreshBtn.addEventListener('click', refreshAll);

    signOutBtn.addEventListener('click', ()=>{
      signOut(auth).catch(e=>console.error(e));
    });

    // auth listener ‚Äî permit only two emails
    onAuthStateChanged(auth, async user => {
      if(!user){
        // not signed in
        adminEmailChip.textContent = 'Not signed in';
        signOutBtn.style.display = 'none';
        // redirect to login page or show message
        statusEl.textContent = 'You must be signed in to access this page. Redirecting to login‚Ä¶';
        // optional: go to your sign-in page. Commented out to avoid surprises.
        // location.href = '/login.html';
        return;
      }

      const email = user.email || 'unknown';
      adminEmailChip.textContent = email;
      signOutBtn.style.display = '';

      if(!ALLOWED.has(email)){
        // not allowed ‚Äî sign out and show message
        statusEl.style.display = 'none';
        errorEl.style.display = '';
        errorEl.textContent = 'Access denied ‚Äî your account is not authorized to view this admin page.';
        // sign out after 2s to be safe
        setTimeout(()=> signOut(auth).catch(()=>{}), 1200);
        return;
      }

      // allowed ‚Äî load counts
      await refreshAll();
    });

    // nice little keyboard shortcut to refresh
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key === 'r'){ e.preventDefault(); refreshAll(); }});

  </script>
</body>
</html>
